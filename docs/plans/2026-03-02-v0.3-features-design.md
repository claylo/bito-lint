# Design: v0.3 Features — Suppression Filtering, Config Discovery, Custom Content

**Date:** 2026-03-02
**Status:** Draft

## Overview

Three features for v0.3.0:

1. **Region-level suppression filtering** — wire the existing `SuppressionMap` line ranges into the lint engine so disable/enable blocks actually filter findings, not just skip entire files.
2. **Broader config file discovery** — support `.bito.<ext>` and `bito.<ext>` alongside existing `bito-lint` names, with figment merge semantics.
3. **Custom content entries** — named markdown blobs in config (inline or file references) that plugins and agents consume without forking. CLI subcommand + MCP tool to resolve and expose them.

## 1. Region-Level Suppression Filtering

### Problem

`directives.rs` parses `disable`/`enable`/`disable-next-line` directives into a `SuppressionMap` with line ranges. But `lint.rs` only calls `is_fully_suppressed()` — file-level skip. Line ranges are parsed and thrown away.

### Approach

Post-analysis filtering. Run the check, then remove findings that fall inside suppressed regions.

**Checks with per-finding location data (filterable):**

| Check | Location field | Unit |
|-------|---------------|------|
| `GrammarIssue` | `sentence_num` | sentence |
| `PassiveVoiceMatch` | `sentence_num` | sentence |
| `StickySentence` | `sentence_num` | sentence |
| `LongSentence` | `sentence_num` | sentence |
| `ComplexParagraph` | `paragraph_num` | paragraph |
| `Echo` | `paragraph` | paragraph |

**Checks that are aggregate-only (file-level suppression only):**
Readability, pacing, transitions, overused words, repeated phrases, sensory, diction, cliches, consistency, acronyms, jargon, conjunction starts, style score.

### Sentence/Paragraph-to-Line Mapping

Findings use sentence or paragraph numbers, but suppressions use source line numbers. We need mapping functions:

- `build_sentence_line_map(original_text: &str) -> Vec<usize>` — index = sentence number (1-indexed), value = source line number where that sentence starts.
- `build_paragraph_line_map(original_text: &str) -> Vec<usize>` — same for paragraphs.

These operate on the **original text** (before markdown stripping) so line numbers match directive positions.

### Filtering Flow

```
1. Parse suppressions from original text → SuppressionMap
2. Build sentence_line_map and paragraph_line_map from original text
3. Run check (on stripped text as today)
4. For each finding with sentence_num:
     source_line = sentence_line_map[sentence_num]
     if suppressions.is_suppressed(check_name, source_line) → drop finding
5. Recompute aggregate counts from filtered findings
```

### Aggregate Recomputation

After filtering grammar findings:
- `passive_count` = filtered `passive_voice.len()`
- `passive_percentage` = recompute from `passive_count / sentence_count`
- `over_max` = recompute against threshold

After filtering sticky sentences:
- `sticky_count` = filtered count of >45% entries
- `semi_sticky_count` = filtered count of 35-45% entries

Similar for other reports.

### What This Does NOT Do

- Does not re-run analysis on sub-regions of text. Analysis runs on the full document; suppressed findings are removed afterward.
- Does not support suppressing aggregate-only checks at line level. Those remain file-level only.
- Does not change the suppression directive syntax.

## 2. Broader Config File Discovery

### Problem

Config discovery only looks for `bito-lint.<ext>` and `.bito-lint.<ext>`. Users of the building-in-the-open plugin (and future bito tools) want a shorter, shared config name: `.bito.<ext>` / `bito.<ext>`.

### Approach

Change `find_project_config` to discover and return multiple config files. Figment merges them in precedence order.

### Discovery Order (figment merge, later = higher precedence)

1. `Serialized::defaults(Config::default())` — compiled defaults
2. User config: `~/.config/bito/config.<ext>` then `~/.config/bito-lint/config.<ext>`
3. Project config (walk-up discovery):
   - `.bito.<ext>` / `bito.<ext>` — general bito config
   - `.bito-lint.<ext>` / `bito-lint.<ext>` — lint-specific overrides
4. Explicit `--config` files
5. `BITO_LINT_*` environment variables

When both `.bito.yaml` and `.bito-lint.yaml` exist in the same directory, both are loaded and merged. The lint-specific file's values override the general file's values.

### API Changes

- `find_project_config(&self, start: &Utf8Path) -> Option<Utf8PathBuf>` becomes `find_project_configs(&self, start: &Utf8Path) -> Vec<Utf8PathBuf>` returning files ordered low-to-high precedence.
- `ConfigSources.project_file: Option<Utf8PathBuf>` becomes `project_files: Vec<Utf8PathBuf>`.
- `ConfigSources::primary_file()` returns the last (highest-precedence) file.
- `find_user_config` also checks `bito` directory as fallback.
- `APP_NAME` logic updated; or introduce `APP_NAMES: &[&str] = &["bito", "bito-lint"]`.

### Walk-Up Behavior

In each directory during walk-up, check all four name patterns × all extensions. Collect all matches from the same directory. The walk-up still stops at the boundary marker — but now returns a vec of all found files across the walk, ordered by precedence.

**Important:** only one directory level contributes project configs. If `.bito-lint.yaml` is found in `./`, we don't also walk up to find `.bito.yaml` in `../`. All project configs come from the same directory (the closest one that has any match).

## 3. Custom Content Entries

### Problem

Users of the building-in-the-open plugin want to define personas, voice/tone guides, style rules, glossaries, and other custom content — without forking the plugin. This content needs to be loadable at session start (via CLI hook) and queryable mid-session (via MCP tool).

### Config Shape

```yaml
custom:
  voice:
    file: "docs/voice-and-tone.md"
  house-style:
    instructions: |
      - Always use Oxford comma
      - Prefer "we" over "I"
      - Technical terms: lowercase unless proper noun
  glossary:
    file: "docs/glossary.md"
  persona-technical:
    instructions: |
      Write for developers. Be direct. Skip the fluff.
```

### Config Struct

```rust
/// A named custom content entry.
#[derive(Debug, Clone, Deserialize, Serialize, PartialEq, Eq)]
pub struct CustomEntry {
    /// Inline markdown instructions.
    pub instructions: Option<String>,
    /// Path to a markdown file (relative to config file, or absolute).
    pub file: Option<Utf8PathBuf>,
}
```

Added to `Config`:
```rust
pub custom: Option<HashMap<String, CustomEntry>>,
```

### Resolution

`resolve_custom_entry(entry: &CustomEntry, config_dir: &Utf8Path) -> Result<String>`:
- If `file` is set, read the file (resolve relative paths against config file's parent directory). Return file contents.
- Else if `instructions` is set, return the inline string.
- Else error: entry has neither file nor instructions.

### CLI: `bito-lint custom`

- `bito-lint custom list` — print names of all custom entries (text or `--json`)
- `bito-lint custom show <name>` — resolve and print the content for a named entry
- `bito-lint custom show <name> --json` — JSON output: `{ "name": "voice", "content": "..." }`

### MCP: `get_custom` tool

```rust
struct GetCustomParams {
    /// Name of the custom entry to retrieve.
    name: String,
}
```

Returns resolved content string, or error if name not found.

### Plugin Integration Pattern

In the building-in-the-open plugin's session-start hook:

```bash
# Inject voice guide into context
bito-lint custom show voice 2>/dev/null
```

The plugin defines which custom entry names it looks for. Users populate those names in their config. No forking required.

## Non-Goals

- **Hot-reload of config in MCP server** — still future work.
- **Lint enforcement against custom content** — future. For now, custom entries are read-only content that agents consume.
- **Finding-level suppression** (filtering individual grammar issues by exact sentence) — we do region-level filtering using sentence-to-line mapping, not sub-sentence precision.

## Key Files to Modify

| File | Changes |
|------|---------|
| `crates/bito-lint-core/src/lint.rs` | Post-analysis filtering with SuppressionMap + line maps |
| `crates/bito-lint-core/src/text.rs` | `build_sentence_line_map()`, `build_paragraph_line_map()` |
| `crates/bito-lint-core/src/config.rs` | `CustomEntry` struct, `find_project_configs()`, broader discovery, `ConfigSources` changes |
| `crates/bito-lint-core/src/lib.rs` | Re-export new public types |
| `crates/bito-lint/src/commands/custom.rs` | New `custom` subcommand |
| `crates/bito-lint/src/commands/mod.rs` | Register `custom` subcommand |
| `crates/bito-lint/src/server.rs` | `get_custom` MCP tool |
| `config/bito-lint.yaml.example` | Add custom section, update discovery docs |
| `config/bito-lint.toml.example` | Same |
